machine:
  node:
    version: 6.3.1
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker
  
dependencies:
  pre:
    - npm install
    - npm test
  override:
    - docker version
    - docker info
    - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" quay.io
    - docker run -v `pwd`:/data quay.io/turner/harbor-deploy:0.2.0-add-catalog-function.15 set_build_values \
      -d /data \
      -b $CIRCLE_BRANCH \
      -n $CIRCLE_BUILD_NUM > props;
    - source props; docker build -t $IMAGE .
    - source props; docker push $IMAGE
    - source props; docker --env-file props run quay.io/turner/harbor-deploy catalog \
      -s ops-$HARBOR_CONTAINER \
      -e dev \
      -t $SHIPMENT_BUILD_TOKEN
      
deployment:
  staging:
    branch: [develop]
    commands:
      - source props; docker --env-file props run quay.io/turner/harbor-deploy deploy \
        -s ops-$HARBOR_CONTAINER \
        -e dev \
        -t $SHIPMENT_BUILD_TOKEN
    branch: [master]
    commands:
      - source props; docker tag $IMAGE quay.io/turner/$HARBOR_CONTAINER:latest
      - source props; docker push quay.io/turner/$HARBOR_CONTAINER:latest
