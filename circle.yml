machine:
  node:
    version: 6.3.1
  pre:
    - curl -sSL https://s3.amazonaws.com/circle-downloads/install-circleci-docker.sh | bash -s -- 1.10.0
  services:
    - docker

test:
  override:
    - npm run junit:
        environment:
          MOCHA_FILE: "${CIRCLE_TEST_REPORTS}/junit/test-results.xml"

dependencies:
  pre:
    - npm install
    - npm test
  override:
    - docker version
    - docker info
    - docker login -e="${DOCKER_EMAIL}" -u="${DOCKER_USER}" -p="${DOCKER_PASSWORD}" quay.io
    - docker run -v $(pwd):/data quay.io/turner/harbor-deploy:0.2.0-add-catalog-function.25 set_build_values \
      -b "${CIRCLE_BRANCH}" \
      -n "${CIRCLE_BUILD_NUM}" > props;
    - echo "SHIPMENT=ops-customs-api" >> props
    - echo "ENVIRONMENT=dev" >> props
    - echo "TOKEN=$SHIPMENT_BUILD_TOKEN" >> props
    - source props; docker build -t "${IMAGE}" .
    - source props; docker push "${IMAGE}"
    - source props; docker run --env-file props quay.io/turner/harbor-deploy:0.2.0-add-catalog-function.25 catalog
    - source props; docker run --env-file props quay.io/turner/harbor-deploy:0.2.0-add-catalog-function.25 deploy
      
deployment:
  staging:
    branch: [develop]
    commands:
      - source props; docker run --env-file props quay.io/turner/harbor-deploy:0.2.0-add-catalog-function.25 deploy
    branch: [master]
    commands:
      - source props; docker tag "${IMAGE}" "${LATEST}"
      - source props; docker push "${LATEST}"
